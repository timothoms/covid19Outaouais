---
title: "Covid19 Situation in Outaouais"
author: "Oskar Timo Thoms"
output: 
  github_document: 
    toc: true
---

```{r setup, include=FALSE}
library(tidyverse)
library(lubridate)
knitr::opts_chunk$set(echo = TRUE)
```
```{r data, include=FALSE}
load("data/covid_local.RData")
load("data/municipalities.RData")
keys <- list(
    cases = list(
        list(c("Cumulative cases (opencovid.ca)", "Cumulative cases", "Healed/resolved cases", "Total cases"), 
             title = "Cumulative cases"),
        list(c("Active cases", "Daily increase", "Deaths", "Average screening test per day"), 
             title = "Other key regional indicators"),
        list(c("Daily increase", "New cases (opencovid.ca)"), 
             title = "Comparing CISSS and opencovid.ca")
    ),
    rls = list(
        list(c("Total", "Total (active)", "RLS de Gatineau", "RLS de Gatineau (active)"), 
             title = "Total & Gatineau"),
        list(c("RLS des Collines-de-l'Outaouais", "RLS des Collines-de-l'Outaouais (active)"), 
             title = "Collines"),
        list(c("RLS de Papineau", "RLS de Papineau (active)"), 
             title = "Papineau"),
        list(c("RLS de la Vallée-de-la-Gatineau", "RLS de la Vallée-de-la-Gatineau (active)"), 
             title = "Vallée-de-la-Gatineau"),
        list(c("RLS du Pontiac", "RLS du Pontiac (active)"), 
             title = "Pontiac")
    ), 
    areas = list(
        list(c("Total cases", "Total", "Gatineau"), 
             title = "Total & Gatineau"),
        list(municipalities$municipality[municipalities$mrc == "Les Collines-de-l'Outaouais"], 
             title = "MRC des Collines-de-l'Outaouais"),
        list(c("Thurso", "Papineauville", "Saint-André-Avellin", "Chénéville","Ripon", "Montebello"), 
             title = "MRC de Papineau"),
        list(municipalities$municipality[municipalities$mrc == "Papineau" & !municipalities$municipality %in% c("Thurso", "Papineauville", "Saint-André-Avellin", "Chénéville","Ripon", "Montebello")], 
             title = "MRC de Papineau (other)"),
        list(c(municipalities$municipality[municipalities$mrc == "La Vallée-de-la-Gatineau" & municipalities$designation == "Ville"], "Messines", "Déléage"), 
             title = "MRC de la Vallée-de-la-Gatineau (Villes & Messines & Déléage)"),
        list(municipalities$municipality[municipalities$mrc == "La Vallée-de-la-Gatineau" & municipalities$designation != "Ville" & !municipalities$municipality %in% c("Messines", "Déléage")], 
             title = "MRC de La Vallée-de-la-Gatineau (other)"),
        list(municipalities$municipality[municipalities$mrc == "Pontiac"], 
             title = "MRC de Pontiac")
        # list(municipalities$municipality[municipalities$mrc == "Hors MRC (autochtones)"], 
        #      title = "Kitigan Zibi & Lac-Rapide" )
    )
)
```

It is difficult to find covid19 trend data at the local level for the Outaouais. The [Quebec government](https://www.quebec.ca/en/health/health-issues/a-z/2019-coronavirus/situation-coronavirus-in-quebec/) shows summaries but only a few days of trend data for regions. [Quebec Public Health](https://www.inspq.qc.ca/covid-19/donnees) shows longer time series but only cumulative snapshots by region. The data aggregated by the [COVID-19 Canada Open Data Working Group (opencovid.ca)](https://opencovid.ca/) can be used to show trends at the health region level. None of these sources provide trend data below the regional level. [CISSS Outaouais](https://cisss-outaouais.gouv.qc.ca/language/en/covid19-en/) provides frequent (sometimes daily) snapshots by Réseaux locaux de services (RLS) and by municipality, but no trends. 

The present project provides local trend data based on these snapshots. The HTML source for the [CISSS Outaouais site](https://cisss-outaouais.gouv.qc.ca/language/en/covid19-en/) is downloaded daily, the tables are scraped and processed into a tidy dataset, to produce the figures on this site. (The [opencovid.ca](https://opencovid.ca/) health region data are included for comparison.) The R code for downloading and processing is made available, but not the software for the daily automation. (This is currently done with Macscheduler and AppleScript.) Note several important caveats when consulting the trend data. 
 
# Caveats

1. There is no guarantee of data accuracy. I am aggregating what CISSS Outaouais has been reporting over time. While I do try to correct obvious data input error, I have (so far) not implemented an automatic error detection process.

2. The date and time reported in the dataset refer to when the CISSS Outaouais website was accessed, not when cases occurred. 

3. The trend data are not complete for several reasons. First, I started regularly downloading the CISSS Outaouais website in fall 2020, and used the [Wayback Machine](https://archive.org/web/) to get earlier snapshots. Unfortunately, due to a nasty syncing glitch, I lost many of the earlier HTML files. (RStudio projects and Dropbox do not play well together; I learnt this the hard way, twice.) Second, the CISSS Outaouais site is not updated every day. Third, running the code from my personal computer means that the automatic download does not happen every day, either because the computer is turned off, or because my software for scheduling scripts has failed a few times. Since the snapshots include cumulative counts, this is not necessarily a problem, but it means that changes in case counts cannot always be precisely dated. 

4. Not all the data available on the CISSS Outaouais site are included in the dataset.

5. Over time, CISSS Outaouais has made various changes to what it reports and how it labels indicators. While I fix some inconsistencies in labels, I do not reconcile closely related indicators. The figures show how reporting has changed.

6. Finally, at the municipal and RLS levels, CISSS Outaouais does not report numbers of less than 6 precisely, likely for good privacy reasons. When "5 or less" are reported, I record this as 5 cases. Consumers of the trend data must be aware that counts of 5 do not precisely reflect the actual situation at those levels, but refer to 1-5 cases.

Last download: `r str_replace(read_file("websites/last_download_time.txt"), "\n", "")`

Last data revision: `r str_replace(read_file("data/data_update_time.txt"), "\n", "")`

# Outaouais Region

```{r cases, echo = FALSE, results = 'hide', dpi = 300, fig.width = 7.5, fig.height = 5, out.width = "100%", out.height = "100%"}
lapply(keys$cases, function(keys) {
    # list(
    ggplot() + 
        geom_line(data = covid[covid$key %in% keys[[1]] & covid$table == "cases", ], mapping = aes(x = time, y = value, group = key, color = key)) + 
        geom_line(data = covid[covid$key %in% keys[[1]] & covid$table == "areas", ], mapping = aes(x = time, y = value, group = key, color = key)) + 
        geom_line(data = covid[covid$key %in% keys[[1]] & covid$table == "rls", ], mapping = aes(x = time, y = value, group = key, color = key)) + 
        labs(x = "", y = "") + theme_classic() + 
        theme(legend.position = "bottom") + theme(legend.title = element_blank()) + ggtitle(keys$title)
    # , ggplot(data = covid[covid$key %in% keys[[1]] & covid$table == "cases" & covid$time > now() - days(42), ]) + 
    #     geom_line(mapping = aes(x = time, y = value, group = key, color = key)) + 
    #     theme_classic() + labs(x = "", y = "") + 
    #     theme(legend.position = "bottom") + 
    #     ggtitle(paste(keys$title, "(last 6 weeks)"))
    # )
})
```

# Réseaux locaux de services (RLS)

```{r rls, echo = FALSE, results = 'hide', dpi = 300, fig.width = 7.5, fig.height = 5, out.width = "100%", out.height = "100%"}
lapply(keys$rls, function(keys) {
    ggplot(data = covid[covid$key %in% keys[[1]] & covid$table == "rls", ]) + 
    geom_line(mapping = aes(x = time, y = value, group = key, color = key)) + 
    labs(x = "", y = "") + ggtitle(keys$title) + theme_classic() + 
    theme(legend.position = "bottom") + theme(legend.title = element_blank()) 
})
```

# Municipalities: cumulative cases

```{r areas, echo = FALSE, results = 'hide', dpi = 300, fig.width = 7.5, fig.height = 5, out.width = "100%", out.height = "100%"}
## FIRST calculate cumulative sums for RLS and municipalities to graph
lapply(keys$areas, function(keys) {
    ggplot(data = covid[covid$key %in% keys[[1]] & covid$table == "areas", ]) + 
        geom_line(mapping = aes(x = time, y = value, group = key, color = key)) + 
        labs(x = "", y = "") + lims(y = c(0, NA)) + theme_classic() + 
        theme(legend.title = element_blank()) + ggtitle(keys$title)
})
```

Page last revised: `r now()`.
