---
title: "Covid19 Situation in Outaouais"
output:
  html_document:
    theme: darkly
    toc: true
params: 
  optimize: false
---

```{r setup, include=FALSE}
library(tidyverse)
library(lubridate)
knitr::knit_hooks$set(optipng = knitr::hook_optipng)
knitr::knit_hooks$set(pngquant = knitr::hook_pngquant)
knitr::opts_chunk$set(echo = FALSE, cache = FALSE, results = 'hide', warning = FALSE)
knitr::opts_chunk$set(dpi = 120, fig.width = 7, fig.height = 5, out.width = "100%", out.height = "100%")
if(params$optimize) knitr::opts_chunk$set(optipng = '-o7')
Sys.setlocale(category = "LC_ALL", locale = "en_CA.UTF-8")
load("data/covid_local.RData")
load("data/covid_local_daily.RData")
load("data/municipalities.RData")
pop_outaouais_2020 <- 401388
load("data/vaccination.RData")
vaccination <- vaccination %>% arrange(key, time)
vaccination$date <- lubridate::as_date(vaccination$time)
vaccination <- vaccination %>% group_by(key, date) %>% filter(time == max(time))
vaccination <- vaccination[vaccination$key == "Outaouais", c("key", "date", "value")]
vaccination$key <- paste("Doses administered in", vaccination$key)
load("data/hospitals.RData")
```

It is difficult to find covid19 trend data over time at the local level for the Outaouais region. 
The [Quebec government](https://www.quebec.ca/en/health/health-issues/a-z/2019-coronavirus/situation-coronavirus-in-quebec/) 
shows summaries but only the last few days of trends for regions. 
[Quebec Public Health](https://www.inspq.qc.ca/covid-19/donnees) 
shows only cumulative snapshots by region. 
The [COVID-19 Canada Open Data Working Group (opencovid.ca)](https://opencovid.ca/) collects official time series data at the provincial and health region levels. 
None of these sources provide trend data below the regional level. 
[CISSS Outaouais](https://cisss-outaouais.gouv.qc.ca/language/en/covid19-en/) provides frequent (sometimes daily) snapshots by Réseaux locaux de services (RLS) and by municipality, but no trends. 
The present project provides local trend data based on these snapshots. 
**Please note important caveats and data limitations at the bottom of this page.**

| Indicators                      | Description                                                                                            |
|---------------------------------|--------------------------------------------------------------------------------------------------------|
| Total cases                     | reported total number of cases of infections to date, aggregated at regional, RLS or municipal level   |
| Active cases                    | total number minus numbers of deaths and healed or resolved cases, aggregated at regional or RLS level |
| Healed / resolved cases         | reported number of resolved cases at regional level                                                    |
| Average increase per day        | average daily increase over last 7 days, calculated from available data                                |
| Total deaths                    | reported total number of deaths at the regional level                                                  |
| Average screening tests per day | reported average daily number of covid-19 tests performed over last 6-7 days                           |
| Hospitalizations                | reported active hospitalizations (excluding ICU) for confirmed covid-19 diagnosis                      |
| Hospitalizations (ICU)          | reported active hospitalizations (in ICU) for confirmed covid-19 diagnosis                             |
| Vaccination                     | Vaccine doses administered in the region (may not be Outaouais residents)                              |

Grid lines indicate Mondays. 
Where relevant, "rugs" indicate dates for which the data are available in the dataset.
If the figures do not show the latest data, reload this page in your web browser.

*April 3, 2021: Newly implemented layout changes to the CISSS website led to errors in yesterday's data update. These errors have been fixed.*

```{r prep}
common_theme <- theme_classic() +
  theme(axis.text.x = element_text(angle = 15, vjust = 1.0, hjust = 1.0),
    legend.position = "bottom",
    legend.title = element_blank(),
    panel.grid.minor.x = element_line(colour="lightgray", size = 0.25),
    plot.caption = element_text(size = rel(0.67)))
```

```{r figure_functions}
LocalFig <- function(keys, tab = c("areas", "rls"), rug = TRUE,
                     caption = "Data source: cisss-outaouais.gouv.qc.ca/language/en/covid19-en/") {
  ggplot(data = covid[covid$key %in% keys & covid$table %in% tab, ]) +
    geom_line(mapping = aes(x = time, y = value, group = key, colour = key)) +
    {if(rug) geom_rug(mapping = aes(x = time), sides = "b", length = unit(0.02, "npc"))} + 
    scale_x_datetime(date_breaks="1 month", date_minor_breaks = "2 weeks", date_labels = "%b %Y") +
    # scale_colour_discrete(breaks = keys) +
    lims(y = c(0, NA)) + common_theme + 
    guides(colour = guide_legend(ncol = 4)) + 
    labs(x = "", y = "", caption = caption)
}
LayeredFig <- function(keys, rug = TRUE) {
  ggplot(mapping = aes(x = time, y = value, group = key, color = key)) +
    geom_line(data = covid[covid$key %in% keys & covid$table == "cases", ]) +
    geom_line(data = covid[covid$key %in% keys & covid$table == "areas", ]) +
    geom_line(data = covid[covid$key %in% keys & covid$table == "rls", ]) +
    {if(rug) geom_rug(data = covid[covid$key %in% keys & covid$table %in% c("cases", "areas", "rls"), ],
                      mapping = aes(x = time), sides = "b", colour = "black", length = unit(0.02, "npc"))} + 
    scale_x_datetime(date_breaks="1 month", date_minor_breaks = "2 weeks", date_labels = "%b %Y") +
    lims(y = c(0, NA)) + common_theme + 
    labs(x = "", y = "", caption = "Data source: cisss-outaouais.gouv.qc.ca/language/en/covid19-en/")
}
DailyFig <- function(keys, tab = "rls", rug = TRUE,
                     caption = "Data source: cisss-outaouais.gouv.qc.ca/language/en/covid19-en/") {
  out <- ggplot(data = daily[daily$change_key %in% keys & daily$table == tab, ]) +
    geom_line(mapping = aes(x = date, y = daily_change_avg, group = change_key, color = change_key)) +
    {if(rug) geom_rug(mapping = aes(x = date), sides = "b", length = unit(0.02, "npc"))} +
    scale_x_date(date_breaks="1 month", date_minor_breaks = "2 weeks", date_labels = "%b %Y") +
    scale_colour_discrete(breaks = keys) +
    lims(y = c(0, NA)) + common_theme + 
    guides(colour = guide_legend(ncol = 3)) + 
    labs(x = "", y = "", caption = caption)
  return(out)
}
RLSactiveFig <- function(keys, rug = TRUE) {
  ggplot(data = covid[covid$key %in% keys & covid$table == "rls_active", ]) +
    geom_line(mapping = aes(x = time, y = value, group = key, color = key)) +
    {if(rug) geom_rug(mapping = aes(x = time), sides = "b", length = unit(0.02, "npc"))} + 
    scale_x_datetime(date_breaks="1 month", date_minor_breaks = "2 weeks", date_labels = "%b %Y") +
    scale_colour_discrete(breaks = keys, labels = keys) +
    lims(y = c(0, NA)) + common_theme + 
    guides(colour = guide_legend(ncol = 3)) + 
    labs(x = "", y = "", caption = "Data source: cisss-outaouais.gouv.qc.ca/language/en/covid19-en/")
}
```

## Outaouais region totals {.tabset .tabset-fade .tabset-pills}

### Average increase
```{r cases_avg}
DailyFig(c("Average increase per day (Outaouais)"), tab = "cases")
```

### Cumulative cases
```{r cases_cumulative}
LayeredFig(c("Healed/resolved cases", "Total cases (Outaouais)")) # "Total cases (RLS)"
```

### Active cases & testing
```{r cases_other}
LayeredFig(c("Active cases", "Average screening tests per day"))
```

### Deaths
```{r cases_deaths}
LayeredFig(c("Total deaths"))
```

### Hospitalization
```{r hospitals}
keys <- c("Hospitalizations", "Hospitalizations in ICU")
ggplot(data = hospitals[hospitals$key %in% keys, ]) +
  geom_line(mapping = aes(x = time, y = value, group = key, colour = key)) +
  scale_x_datetime(date_breaks="1 month", date_minor_breaks = "2 weeks", date_labels = "%b %Y") +
  lims(y = c(0, NA)) + common_theme + 
  labs(x = "", y = "", caption = "Data source: www.donneesquebec.ca/recherche/dataset/covid-19-portrait-quotidien-des-hospitalisations")
```

### Vaccination
```{r vaccination}
ggplot(data = vaccination) +
  geom_line(mapping = aes(x = date, y = value, group = key, color = key)) +
  scale_x_date(date_breaks="1 day") +
  scale_y_continuous(name = "",
    sec.axis = sec_axis(trans = ~ . / pop_outaouais_2020 * 100, name = "% of 2020 population")
  ) + theme_classic() + common_theme + 
  theme(plot.caption = element_text(size = rel(0.67))) +
  labs(x = "", y = "", caption = "Data source: www.quebec.ca/en/health/health-issues/a-z/2019-coronavirus/situation-coronavirus-in-quebec/covid-19-vaccination-data/")
```

## opencovid.ca (Outaouais and Ottawa) {.tabset .tabset-fade .tabset-pills}

### Average increase
```{r opencovid_avg}
DailyFig(c("Average increase per day (Outaouais)", "Average increase per day (Ottawa)"), 
         tab = "opencovid.ca", rug = FALSE, caption = "Data source: opencovid.ca/api/")
```

### Cumulative cases
```{r opencovid_total}
LocalFig(c("Total cases (Outaouais)", "Total cases (Ottawa)"), 
         tab = c("opencovid.ca"), rug = FALSE, caption = "Data source: opencovid.ca/api/")
```

### Deaths
```{r deaths_opencovid}
LocalFig(c("Total deaths (Outaouais)", "Total deaths (Ottawa)")
         , tab = c("opencovid.ca"), rug = FALSE, caption = "Data source: opencovid.ca/api/")
```

## Average increase by Réseaux locaux de services {.tabset .tabset-fade .tabset-pills}

### Gatineau
```{r rls_new_gatineau}
DailyFig(c("RLS de Gatineau"))
```

### Collines-de-l'Outaouais
```{r rls_new_collines}
DailyFig(c("RLS des Collines-de-l'Outaouais"))
```

### Pontiac
```{r rls_new_pontiac}
DailyFig(c("RLS du Pontiac"))
```

### Papineau
```{r rls_new_papineau}
DailyFig(c("RLS de Papineau"))
```

### Vallée-de-la-Gatineau
```{r rls_new_vallee}
DailyFig(c("RLS de la Vallée-de-la-Gatineau"))
```

## Active cases by Réseaux locaux de services {.tabset .tabset-fade .tabset-pills}

### Gatineau
```{r rls_active_gatineau}
RLSactiveFig(c("RLS de Gatineau"))
```

### Collines-de-l'Outaouais
```{r rls_active_collines}
RLSactiveFig(c("RLS des Collines-de-l'Outaouais"))
```

### Pontiac
```{r rls_pontiac}
RLSactiveFig(c("RLS du Pontiac"))
```

### Papineau
```{r rls_active_papineau}
RLSactiveFig(c("RLS de Papineau"))
```

### Vallée-de-la-Gatineau
```{r rls_active_vallee}
RLSactiveFig(c("RLS de la Vallée-de-la-Gatineau"))
```

## Cumulative cases by municipalities and Réseaux locaux de services {.tabset .tabset-fade .tabset-pills}

### Total in municipalities & Gatineau
```{r areas_gatineau}
LocalFig(c("Gatineau", "Total cases (municipalities)"))
```

### Collines-de-l'Outaouais
```{r areas_collines}
LocalFig(municipalities$municipality[municipalities$mrc == "Les Collines-de-l'Outaouais"])
```

### Papineau
```{r areas_papineau}
exclude <- c("Thurso", "Papineauville", "Saint-André-Avellin", "Chénéville","Ripon", "Montebello")
LocalFig(keys = exclude)
```

### Papineau
```{r areas_papineau_cont}
LocalFig(municipalities$municipality[municipalities$mrc == "Papineau" & 
                                     !municipalities$municipality %in% exclude])
```

### Vallée-de-la-Gatineau
```{r areas_papineau_vallee}
exclude <- c("Messines", "Déléage", "Bouchette")
LocalFig(c(municipalities$municipality[municipalities$mrc == "La Vallée-de-la-Gatineau" & 
                                       municipalities$designation == "Ville"], exclude))
```

### Vallée-de-la-Gatineau
```{r areas_papineau_vallee_cont}
LocalFig(municipalities$municipality[municipalities$mrc == "La Vallée-de-la-Gatineau" & 
                                     municipalities$designation != "Ville" & 
                                     !municipalities$municipality %in% exclude])
```

### Pontiac
```{r areas_pontiac}
LocalFig(municipalities$municipality[municipalities$mrc == "Pontiac"])
```

### Réseaux locaux de services
```{r rls_cumulative}
keys <- c("RLS de la Vallée-de-la-Gatineau", "RLS de Papineau", 
          "RLS des Collines-de-l'Outaouais", "RLS du Pontiac")
LocalFig(keys = keys)
```

### RLS Gatineau
```{r rls_gatineau}
LocalFig(c("RLS de Gatineau"))
```

## Method and caveats

The HTML source for the [CISSS Outaouais site](https://cisss-outaouais.gouv.qc.ca/language/en/covid19-en/) is downloaded daily, the tables are scraped and processed into a tidy dataset, to produce the figures on this site. 
The latest [opencovid.ca](https://opencovid.ca/) health region data are included for comparison. 
Historical hospitalization data come from the [Ministère de la Santé et des Services sociaux](https://www.donneesquebec.ca/recherche/dataset/covid-19-portrait-quotidien-des-hospitalisations).
The source code for downloading and processing all data is available in the project [GitHub repository](https://github.com/timothoms/covid19Outaouais). 
Daily automation is currently done with MacScheduler.

Users of these data need to be aware of the following caveats:

1. There is no guarantee of data accuracy. I am aggregating what CISSS Outaouais has been reporting over time. While I do try to correct obvious data input error, I have (so far) not implemented an automatic error detection process.

2. The date and time in the dataset refer to when the CISSS Outaouais website was accessed, not when cases occurred.

3. The trend data are not complete (i.e daily) for several reasons. First, I started regularly downloading the CISSS Outaouais source in fall 2020, and used the [Wayback Machine](https://archive.org/web/) to get earlier snapshots. Unfortunately, due to a nasty syncing glitch, I lost some HTML source files. (RStudio projects and Dropbox do not play well together; I learnt this the hard way, twice.) Second, the CISSS Outaouais site is not updated every day. Third, running the code from my personal computer means that the automatic download does not happen every day, either because the computer is turned off, or because my software for scheduling scripts has failed a few times. Since the snapshots include cumulative counts, this is not necessarily a problem, but it means that changes in case counts cannot always be precisely dated.

4. Not all the data available on the CISSS Outaouais site are currently included in the dataset.

5. Over time, CISSS Outaouais has made changes to what it reports and how it labels indicators. While I fix some inconsistencies in labels, I do not reconcile closely related indicators. The figures show how reporting by CISSS Outaouais has changed.

6. At the municipal and RLS levels, CISSS Outaouais does not report numbers of less than 6 precisely, likely for good privacy reasons. When "5 or less" are reported, I record this as 5 cases. Users of this dataset must be aware that counts of 5 do not precisely reflect the actual situation at those levels, but refer to 1-5 cases.

7. Expressing vaccination doses as a percentage of the Outaouais population (in 2020) assumes that receivers of the vaccine are Outaouais residents **and** they have received one dose only. These strong assumptions may be reasonable early in the vaccination campaign, but less so as time progresses.  

\  

Updates usually occur after 5pm. 

Last HTML source download: `r str_replace(read_file("websites/last_download_time.txt"), "\n", "")`

Last opencovid update: `r str_replace(read_file("data/opencovid_update_time.txt"), "\n", "")`

Last dataset revision: `r str_replace(read_file("data/data_update_time.txt"), "\n", "")`

Last website update: `r now()`

\  

This website is maintained by Timo Thoms. Questions, concerns, and suggestions can be raised through [GitHub Discussions](https://github.com/timothoms/covid19Outaouais/discussions).
