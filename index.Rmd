---
title: "Covid19 Situation in Outaouais"
output:
  html_document:
    theme: darkly
    toc: true
    toc_depth: 1
    includes:
      before_body: content/translate.html
params: 
  optimize: false
---

```{r setup, include=FALSE}
library(tidyverse)
library(lubridate)
knitr::knit_hooks$set(optipng = knitr::hook_optipng)
knitr::knit_hooks$set(pngquant = knitr::hook_pngquant)
knitr::opts_chunk$set(echo = FALSE, cache = FALSE, results = 'hide', warning = FALSE, message = FALSE)
knitr::opts_chunk$set(dpi = 120, fig.width = 7, fig.height = 5, out.width = "100%", out.height = "100%")
if(params$optimize) knitr::opts_chunk$set(optipng = '-o7')
Sys.setlocale(category = "LC_ALL", locale = "en_CA.UTF-8")
load("data/covid_local.RData")
load("data/covid_local_daily.RData")
load("data/municipalities.RData")
load("data/hospitalization.RData")
load("data/inspq.RData")
load("data/rls.RData")
rls <- rls %>% arrange(key, time)
load("data/vaccination.RData")
vaccination <- vaccination %>% 
  mutate(date = lubridate::as_date(vaccination$time)) %>% 
  group_by(key, date) %>% filter(time == max(time)) 
pop_outaouais_2020 <- 401388
```

```{r, child = 'content/index_intro.md'}
```

```{r figure_functions}
common_theme <- theme_classic() +
  theme(axis.text.x = element_text(angle = 15, vjust = 1.0, hjust = 1.0),
        axis.title = element_blank(),
        legend.position = "top",
        legend.title = element_blank(),
        # legend.text = element_text(size = rel(0.67)),
        legend.margin = margin(0, 0, 0, 0),
        panel.grid.minor.x = element_line(colour="lightgray", size = 0.25),
        plot.caption = element_text(size = rel(0.67)))
LayeredFig <- function(keys, 
                       rug = TRUE, 
                       per_pop = FALSE,
                       caption = "Data source: cisss-outaouais.gouv.qc.ca/language/en/covid19-en/"
){
  caption <- paste("Last day in dataset: ", format(max(covid$time), "%b %d"), ". ", caption, sep = "")
  ggplot(mapping = aes(x = time, y = value, group = key, color = key)) +
    geom_line(data = covid[covid$key %in% keys & covid$table == "cases", ]) +
    geom_line(data = covid[covid$key %in% keys & covid$table == "areas", ]) +
    # geom_line(data = covid[covid$key %in% keys & covid$table == "rls", ]) +
    { if(per_pop) 
      scale_y_continuous(sec.axis = sec_axis(trans = ~ . / pop_outaouais_2020 * 100000, 
                                             name = "per 100,000 population (2020)"),
                         limits = c(0, NA)) 
      else 
        lims(y = c(0, NA)) 
    } +
    { if(rug) 
      geom_rug(data = covid[covid$key %in% keys & covid$table %in% c("cases", "areas", "rls"), ],
               mapping = aes(x = time), sides = "b", colour = "black", length = unit(0.02, "npc")) 
    } + 
    scale_x_datetime(date_breaks="1 month", date_minor_breaks = "2 weeks", date_labels = "%b %Y") +
    common_theme + 
    labs(x = "", y = "", caption = caption)
}
DailyFig <- function(keys, 
                     tab = "rls", 
                     rug = TRUE, 
                     per_pop = FALSE,
                     caption = "Data source: cisss-outaouais.gouv.qc.ca/language/en/covid19-en/"
){
  df <- daily[daily$change_key %in% keys & daily$table == tab, ]
  caption <- paste("Last day in dataset: ", format(max(df$date), "%b %d"), ". ", caption, sep = "")
  ggplot(data = df) +
    geom_line(mapping = aes(x = date, y = daily_change_avg, group = change_key, color = change_key)) +
    { if(per_pop) 
      scale_y_continuous(sec.axis = sec_axis(trans = ~ . / pop_outaouais_2020 * 100000, 
                                             name = "per 100,000 population (2020)"),
                                    limits = c(0, NA)) else lims(y = c(0, NA)) 
    } +
    { if(rug) 
      geom_rug(mapping = aes(x = date), sides = "b", length = unit(0.02, "npc"))
    } +
    scale_x_date(date_breaks="1 month", date_minor_breaks = "2 weeks", date_labels = "%b %Y") +
    common_theme + 
    guides(colour = guide_legend(ncol = 3)) + 
    labs(x = "", y = "", caption = caption)
}
RegionFig <- function(df, 
                      second = NULL, 
                      bars = NULL, 
                      caption, 
                      pop = NULL, 
                      dlabels = "%b %Y", 
                      legend_cols = 3)
{
  caption <- paste("Last day in dataset: ", format(max(df$date), "%b %d"), ". ", caption, sep = "")
  ggplot(data = df[df$date > "2020-03-15", ],
         mapping = aes(x = date, y = value, group = key, color = key)) +
    { if(!is.null(bars)) 
      geom_bar(data = bars[bars$date > "2020-03-15", ], 
               mapping = aes(fill = unique(bars$key)),
               stat = "identity", color = "lightgray")
    } + 
    scale_fill_manual(labels = unique(bars$key), values = "lightgray") +
    geom_line() +
    { if(!is.null(second)) 
      geom_line(data = second[second$date > "2020-03-15", ])
    } + 
    scale_x_date(date_breaks = "1 month", date_minor_breaks = "2 weeks", date_labels = dlabels) +
    { if(!is.null(pop)) {
        if(pop == "percent") {
          p <- list(denom = 100, label = "% of 2020 population")
        }
        if(pop == "per100k") {
          p <- list(denom = 100000, label = "per 100,000 population (2020)")
        }
        scale_y_continuous(limits = c(0, NA),
                           sec.axis = sec_axis(trans = ~ . /pop_outaouais_2020*p$denom, name = p$label))
      
      } else lims(y = c(0, NA))
    } +
    common_theme + 
    guides(colour = guide_legend(ncol = legend_cols)) + 
    labs(x = "", y = "", caption = caption)
}
RLSFig <- function(df, caption, legend_cols = 2) {
  # caption <- paste("Last day in dataset: ", format(max(df$time), "%b %d"), ". ", caption, sep = "")
  ggplot(data = df) +
    geom_line(mapping = aes(x = time, y = value, group = key, color = key)) +
    scale_x_datetime(date_breaks = "1 month", date_minor_breaks = "2 weeks", date_labels = "%b %Y") +
    common_theme + 
    guides(colour = guide_legend(ncol = legend_cols)) + 
    labs(x = "", y = "", caption = caption)
}
LocalFig <- function(keys, 
                     tab = c("areas", "rls"), 
                     rug = TRUE,
                     legend_cols = 4,
                     caption = "Data source: cisss-outaouais.gouv.qc.ca/language/en/covid19-en/"
){
  df <- covid[covid$key %in% keys & covid$table %in% tab, ]
  caption <- paste("Last day in dataset: ", format(max(df$time), "%b %d"), ". ", caption, sep = "")
  ggplot(data = df) +
    geom_line(mapping = aes(x = time, y = value, group = key, colour = key)) +
    { if(rug) 
      geom_rug(mapping = aes(x = time), sides = "b", length = unit(0.02, "npc")) 
    } + 
    scale_x_datetime(date_breaks="1 month", date_minor_breaks = "2 weeks", date_labels = "%b %Y") +
    # scale_colour_discrete(breaks = keys, labels = keys) +
    lims(y = c(0, NA)) + 
    common_theme + 
    guides(colour = guide_legend(ncol = legend_cols)) + 
    labs(x = "", y = "", caption = caption)
}
```

# Outaouais region totals {.tabset .tabset-fade .tabset-pills}

## New cases
```{r cases_avg}
## DailyFig(c("Average increase per day (Outaouais)"), tab = "cases", per_pop = TRUE)
RegionFig(df = inspq[inspq$key == "Average increase per day", ], 
          bars = inspq[inspq$key == "New cases", ], 
          pop = "per100k",
          caption = "Data source: www.inspq.qc.ca/sites/default/files/covid/donnees/covid19-hist.csv")
```

## Active cases
```{r cases_active}
## LayeredFig(c("Active cases"))
RegionFig(df = inspq[inspq$key %in% c("Active cases"), ], # "New cases, lab", "New cases, epi link", 
          pop = "per100k", caption = "Data source: www.inspq.qc.ca/sites/default/files/covid/donnees/covid19-hist.csv")
```

## Cumulative cases
```{r cases_cumulative}
## LayeredFig(c("Healed/resolved cases", "Total cases (Outaouais)")) # "Total cases (RLS)"
RegionFig(df = inspq[inspq$key %in% c("Total cases", "Total recovered cases"), ], # "Total cases, lab" 
          caption = "Data source: www.inspq.qc.ca/sites/default/files/covid/donnees/covid19-hist.csv")
```

## Deaths
```{r cases_deaths}
## LayeredFig(c("Total deaths"))
RegionFig(df = inspq[inspq$key %in% c("Total deaths", "Total deaths (CHSLD)", "Total deaths (RPA)", "Total deaths (other)"), ], 
          caption = "Data source: www.inspq.qc.ca/sites/default/files/covid/donnees/covid19-hist.csv")
```

## Hospitalizations
```{r hospitalization}
RegionFig(df = hospitalization[hospitalization$key %in% c("Active hospitalizations, non-ICU", "Active hospitalizations, ICU"), ],
          second = inspq[inspq$key %in% c("New hospitalizations, non-ICU", "New hospitalizations, ICU"), ], 
          caption = "Data source: www.inspq.qc.ca/sites/default/files/covid/donnees/covid19-hist.csv &\n www.donneesquebec.ca/recherche/dataset/covid-19-portrait-quotidien-des-hospitalisations")
```

## Total hospitalizations
```{r hospitalizations}
RegionFig(df = inspq[inspq$key %in% c("Total hospitalizations, non-ICU", "Total hospitalizations, ICU", "Total hospitalizations"), ], 
          caption = "Data source: www.inspq.qc.ca/sites/default/files/covid/donnees/covid19-hist.csv")
```

## Vaccination
```{r vaccination}
## RegionFig(df = vaccination,
##         caption = "Data source: www.quebec.ca/en/health/health-issues/a-z/2019-coronavirus/situation-coronavirus-in-quebec/covid-19-vaccination-data/")
RegionFig(df = inspq[inspq$key %in% c("Vaccine doses administered", "Total vaccine doses administered"), ], 
          pop = "percent", dlabels = "%d %b %Y",
          caption = "Data source: www.inspq.qc.ca/sites/default/files/covid/donnees/covid19-hist.csv")
```

# opencovid.ca (Outaouais & Ottawa) {.tabset .tabset-fade .tabset-pills}

```{r, child = 'content/note_ottawa.md'}
```

## Average increase
```{r opencovid_avg}
DailyFig(c("Average increase per day (Outaouais)", "Average increase per day (Ottawa)"), 
         tab = "opencovid.ca", rug = FALSE, 
         caption = "Data source: opencovid.ca/api/")
```

## Cumulative cases
```{r opencovid_total}
LocalFig(c("Total cases (Outaouais)", "Total cases (Ottawa)"), 
         tab = c("opencovid.ca"), rug = FALSE, 
         caption = "Data source: opencovid.ca/api/")
```

## Deaths
```{r deaths_opencovid}
LocalFig(c("Total deaths (Outaouais)", "Total deaths (Ottawa)"), 
         tab = c("opencovid.ca"), rug = FALSE, 
         caption = "Data source: opencovid.ca/api/")
```

# Testing in Outaouais {.tabset .tabset-fade .tabset-pills}

## Daily Tests
```{r testing}
## LayeredFig(c("Average screening tests per day"))
RegionFig(df = inspq[inspq$key %in% c("Average testing per day"), ],
          bars = inspq[inspq$key %in% c("Persons tested"), ],
          caption = "Data source: www.inspq.qc.ca/sites/default/files/covid/donnees/covid19-hist.csv")
```

## Positive tests
```{r positive}
RegionFig(df = inspq[inspq$key %in% c("Average positive tests per day"), ], 
          bars = inspq[inspq$key %in% c("Persons tested positive"), ],
          caption = "Data source: www.inspq.qc.ca/sites/default/files/covid/donnees/covid19-hist.csv")
```

## Test positivity
```{r positivity}
RegionFig(df = inspq[inspq$key %in% c("Average test positivity (%)"), ], 
          bars = inspq[inspq$key %in% c("Test positivity (%)"), ], 
          caption = "Data source: www.inspq.qc.ca/sites/default/files/covid/donnees/covid19-hist.csv")
```

# Average increase & cumulative cases by RLS {.tabset .tabset-fade .tabset-pills}

## Gatineau & Outaouais
```{r rls_avg_gatineau}
## DailyFig(c("RLS de Gatineau"))
RLSFig(df = rls[rls$key %in% c("Average increase per day (Outaouais)", "Active cases (Outaouais)", "RLS de Grande-Rivière - Hull - Gatineau") & rls$table == "average", ], 
       caption = "Data source: www.inspq.qc.ca/sites/default/files/covid/donnees/tableau-rls-new.csv")
```

## Collines
```{r rls_avg_collines}
## DailyFig(c("RLS des Collines-de-l'Outaouais"))
RLSFig(df = rls[rls$key == "RLS des Collines-de-l'Outaouais" & rls$table == "average", ], 
       caption = "Data source: www.inspq.qc.ca/sites/default/files/covid/donnees/tableau-rls-new.csv")
```

## Pontiac
```{r rls_avg_pontiac}
## DailyFig(c("RLS du Pontiac"))
RLSFig(df = rls[rls$key == "RLS du Pontiac" & rls$table == "average", ], 
       caption = "Data source: www.inspq.qc.ca/sites/default/files/covid/donnees/tableau-rls-new.csv")
```

## Papineau
```{r rls_avg_papineau}
## DailyFig(c("RLS de Papineau"))
RLSFig(df = rls[rls$key == "RLS de la Vallée-de-la-Lièvre et de la Petite Nation" & rls$table == "average", ], 
       caption = "Data source: www.inspq.qc.ca/sites/default/files/covid/donnees/tableau-rls-new.csv")
```

## Vallée
```{r rls_avg_vallee}
## DailyFig(c("RLS de la Vallée-de-la-Gatineau"))
RLSFig(df = rls[rls$key == "RLS de la Vallée-de-la-Gatineau" & rls$table == "average", ], 
       caption = "Data source: www.inspq.qc.ca/sites/default/files/covid/donnees/tableau-rls-new.csv")
```

## Cumulative, Gatineau
```{r rls_cumulative_gatineau}
RLSFig(df = rls[rls$key %in% c("Total cases (Outaouais)", "RLS de Grande-Rivière - Hull - Gatineau") & rls$table == "cases", ], 
       caption = "Data source: www.inspq.qc.ca/sites/default/files/covid/donnees/tableau-rls-new.csv")
```

## Cumulative, other
```{r rls_cumulative_other}
RLSFig(df = rls[rls$key %in% c("RLS des Collines-de-l'Outaouais", "RLS du Pontiac", "RLS de la Vallée-de-la-Lièvre et de la Petite Nation", "RLS de la Vallée-de-la-Gatineau") & rls$table == "cases", ], 
       caption = "Data source: www.inspq.qc.ca/sites/default/files/covid/donnees/tableau-rls-new.csv")
```

# Active cases by RLS {.tabset .tabset-fade .tabset-pills}

## Gatineau & Outaouais
```{r rls_active_gatineau}
## LocalFig(c("RLS de Gatineau"), tab = c("rls_active"), legend_cols = 3)
RLSFig(df = rls[rls$key %in% c("Active cases (Outaouais)", "RLS de Grande-Rivière - Hull - Gatineau") & rls$table == "active", ], 
       caption = "Data source: www.inspq.qc.ca/sites/default/files/covid/donnees/tableau-rls-new.csv")
```

## Collines
```{r rls_active_collines}
## LocalFig(c("RLS des Collines-de-l'Outaouais"), tab = c("rls_active"), legend_cols = 3)
RLSFig(df = rls[rls$key == "RLS des Collines-de-l'Outaouais" & rls$table == "active", ], 
       caption = "Data source: www.inspq.qc.ca/sites/default/files/covid/donnees/tableau-rls-new.csv")
```

## Pontiac
```{r rls_pontiac}
## LocalFig(c("RLS du Pontiac"), tab = c("rls_active"), legend_cols = 3)
RLSFig(df = rls[rls$key == "RLS du Pontiac" & rls$table == "active", ], 
       caption = "Data source: www.inspq.qc.ca/sites/default/files/covid/donnees/tableau-rls-new.csv")
```

## Papineau
```{r rls_active_papineau}
## LocalFig(c("RLS de Papineau"), tab = c("rls_active"), legend_cols = 3)
RLSFig(df = rls[rls$key == "RLS de la Vallée-de-la-Lièvre et de la Petite Nation" & rls$table == "active", ], 
       caption = "Data source: www.inspq.qc.ca/sites/default/files/covid/donnees/tableau-rls-new.csv")
```

## Vallée
```{r rls_active_vallee}
## LocalFig(c("RLS de la Vallée-de-la-Gatineau"), tab = c("rls_active"), legend_cols = 3)
RLSFig(df = rls[rls$key == "RLS de la Vallée-de-la-Gatineau" & rls$table == "active", ], 
       caption = "Data source: www.inspq.qc.ca/sites/default/files/covid/donnees/tableau-rls-new.csv")
```

# Cumulative cases by municipalities {.tabset .tabset-fade .tabset-pills}

## Total & Gatineau
```{r areas_gatineau}
LocalFig(c("Gatineau", "Total cases (municipalities)"))
```

## Collines
```{r areas_collines}
LocalFig(municipalities$municipality[municipalities$mrc == "Les Collines-de-l'Outaouais"])
```

## Papineau
```{r areas_papineau}
exclude_papineau <- c("Thurso", "Papineauville", "Saint-André-Avellin", "Chénéville","Ripon", "Montebello")
LocalFig(keys = exclude_papineau)
```

## Papineau (<20)
```{r areas_papineau_cont}
LocalFig(municipalities$municipality[municipalities$mrc == "Papineau" & 
                                     !municipalities$municipality %in% exclude_papineau])
```

## Vallée
```{r areas_vallee}
exclude_vallee <- c("Messines", "Déléage", "Bouchette")
LocalFig(c(municipalities$municipality[municipalities$mrc == "La Vallée-de-la-Gatineau" & 
                                       municipalities$designation == "Ville"], exclude_vallee))
```

## Vallée (<20)
```{r areas_vallee_cont}
LocalFig(municipalities$municipality[municipalities$mrc == "La Vallée-de-la-Gatineau" & 
                                     municipalities$designation != "Ville" & 
                                     !municipalities$municipality %in% exclude_vallee])
```

## Pontiac
```{r areas_pontiac}
LocalFig(municipalities$municipality[municipalities$mrc == "Pontiac"])
```

# Information on this site {.tabset .tabset-pills}

```{r, child = 'content/index_notes.md'}
```

```{r, child = 'content/updates.md'}
```

<!-- Last HTML download: `r str_replace(read_file("websites/last_download_time.txt"), "\n", "")` -->

Last data revision: `r str_replace(read_file("data/data_update_time.txt"), "\n", "")`

Last page update: `r now()`

```{r, child = 'content/table_glossary.md'}
```

```{r, child = 'content/table_sources.md'}
```

```{r, child = 'content/disclaimer.md'}
```

```{r, child = 'content/footer.md'}
```
